#!/bin/bash

if [ $# = 0 ]; then
  echo "Usage: $0 [-l] <rpm> [ <rpm> ... ]"
  echo "Shows everything about one or more rpms."
  exit 1
fi

if [ "$1" = '-l' ]; then
  output_format=( -l )
  less_opts=( )
  shift
else  
  divider="$( perl -e 'print "-" x 78' )" # sledgehammer
  output_format=(
      -iv 
      --qf "$divider\n" 
      --qf "Arch: %{ARCH}\n" 
      --qf "$divider\n" 
      --qf "Requires:\n"  --requires 
      --qf "$divider\n" 
      --qf "Provides:\n"  --provides 
      --qf "$divider\n" 
      --qf "Scripts:\n"   --scripts --triggers 
      --qf "$divider\n" 
      --qf "Changelog:\n" --changelog 
      --qf "$divider\n" 
      --qf "Files:\n"     --list 
  )
  less_opts=( '+/^-{78}
g' )
fi

while [ -n "$1" ]; do
  rpm="$1"
  shift

  popt=''
  case "$rpm" in
      *.rpm) [ -e "$rpm" ] && popt='p' ;;
        */*) [ -e "$rpm" ] && popt='f' ;;
  esac

  # Work on executables in $PATH too
  if [ -z "$popt" ]; then
    if exe=$( which "$rpm" 2>/dev/null ) && ! rpm -q "$rpm" >&/dev/null; then
      popt='f'
      rpm="$exe"
    fi
  fi

  rpm -q$popt "${output_format[@]}" -- "$rpm"
done | less -S "${less_opts[@]}"
